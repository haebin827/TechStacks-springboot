<!doctype html>
<html xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      xmlns:th="http://www.thymeleaf.org"
      layout:decorate="~{layout/basic.html}">

<div layout:fragment="content">
    <h3 th:if="${session.userLogin != null}">Hi, <span th:text="${session.uName}"></span></h3>
    <h3 th:if="${session.adminLogin != null}">[Admin Mode]</h3>

    <div id="carouselExampleIndicators" class="carousel slide" data-bs-ride="carousel" data-bs-interval="3000" data-bs-pause="false">
        <div class="carousel-indicators">
            <button type="button" data-bs-target="#carouselExampleIndicators" data-bs-slide-to="0" class="active" aria-current="true" aria-label="Slide 1"></button>
            <button type="button" data-bs-target="#carouselExampleIndicators" data-bs-slide-to="1" aria-label="Slide 2"></button>
            <button type="button" data-bs-target="#carouselExampleIndicators" data-bs-slide-to="2" aria-label="Slide 3"></button>
        </div>
        <div class="carousel-inner">
            <div class="carousel-item active">
                <img src="/images/cover.png" class="d-block w-100" alt="...">
            </div>
            <div class="carousel-item">
                <img src="/images/default.png" class="d-block w-100" alt="...">
            </div>
            <div class="carousel-item">
                <img src="/images/image.png" class="d-block w-100" alt="...">
            </div>
        </div>
        <button class="carousel-control-prev" type="button" data-bs-target="#carouselExampleIndicators" data-bs-slide="prev">
            <span class="carousel-control-prev-icon" aria-hidden="true"></span>
            <span class="visually-hidden">Previous</span>
        </button>
        <button class="carousel-control-next" type="button" data-bs-target="#carouselExampleIndicators" data-bs-slide="next">
            <span class="carousel-control-next-icon" aria-hidden="true"></span>
            <span class="visually-hidden">Next</span>
        </button>
    </div>


    <!-- Î™®Îã¨ Ï∞Ω ÏãúÏûë -->
    <div class="modal fade" tabindex="-1" id="warningModal">
        <div class="modal-dialog modal-lg">
            <div class="modal-content alert alert-warning">
                <div class="modal-header">
                    <h5 class="modal-title">Warning‚ö†Ô∏è</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p id="modalResult"></p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>
    <!-- Î™®Îã¨ Ï∞Ω ÎÅù -->

    <!-- Account deleted Modal -->
    <div class="modal fade" id="accountDeleteModal" tabindex="-1" aria-labelledby="accountDeleteModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="accountDeleteModalLabel">Account has been deleted</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p id="accountDeleteModalResult"></p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Level Up Modal -->
    <div class="modal fade" id="levelUpModal" tabindex="-1" aria-labelledby="levelUpModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="levelUpModalLabel">Congratulationsüéâ</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p id="levelUpModalResult"></p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Yes!</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Admin Password Change Modal -->
    <div class="modal fade" id="adminPasswordChangeModal" tabindex="-1" aria-labelledby="adminPasswordChangeModalLabel" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="adminPasswordChangeModalLabel">Initial Login Password Reset <b>(Mandatory)</b></h5>
                </div>
                <div class="modal-body">
                    <form id="passwordChangeForm" method="post" action="/home">
                        <div class="mb-3">
                            <label for="newPassword" class="form-label">New Password</label>
                            <input type="password" class="form-control" id="newPassword" name="newPassword" required>
                        </div>
                        <div class="mb-3">
                            <label for="confirmPassword" class="form-label">Confirm Password</label>
                            <input type="password" class="form-control" id="confirmPassword" name="confirmPassword" required>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-dark" id="submitPasswordChange">Change Password</button>
                </div>
            </div>
        </div>
    </div>

</div>
</div>

<script layout:fragment="script" th:inline="javascript">

    // Function to format date as YYYY-MM-DD
    function formatDate(dateStr) {
        const date = new Date(dateStr);
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const day = String(date.getDate()).padStart(2, '0');
        return `${year}-${month}-${day}`;
    }

    // Show modal
    document.addEventListener('DOMContentLoaded', function () {
        var dateLeft = [[${dateLeft}]];
        var uRegDate = [[${uRegDate}]]; // Assuming uRegDate is in ISO 8601 format

        console.log("dateLeft:", dateLeft);
        console.log("Registered Date:", uRegDate);

        if (dateLeft) {
            var formattedDate = formatDate(uRegDate);
            var message = "";

            for (var i = 7; i >= 1; i--) {
                if (dateLeft == i.toString()) {
                    message = "<span style='font-size: 1.15rem;'><b><span style='color:red;'>" + dateLeft + "</span></b> " +
                        (dateLeft == "1" ? "day" : "days") +
                        " remain until your account is automatically deleted.<br></span>" +
                        "<span style='color:#ff6666;'><i><b>Inactive accounts are only valid for 6 months from the date of registration.</b></i></span><br><br>" +
                        "<b>Registered date:</b> " + formattedDate;

                    break; // Ï†ÅÌï©Ìïú Î©îÏãúÏßÄÎ•º Ï∞æÏúºÎ©¥ Î∞òÎ≥µÏùÑ Ï§ëÏßÄ
                } else if (dateLeft == "0") {
                    message = "<span style='font-size: 1.15rem;'><b>Your account has been deleted as of today. Please contact the administrator for details.</b></span><br><br>" +
                        "<span style='color:#ff6666;'><i><b>Inactive accounts are only valid for 6 months from the date of registration.</b></i></span><br>" +
                        "<b>Registered date:</b> " + formattedDate;
                }
            }

            if (message) {
                document.querySelector("#modalResult").innerHTML = message;
                var modal = new bootstrap.Modal(document.querySelector("#warningModal"));
                modal.show();
            }

            // ÏûêÎèô Î°úÍ∑∏ÏïÑÏõÉ Ï≤òÎ¶¨
            if (dateLeft == "0") {
                var warningModal = document.querySelector("#warningModal");

                warningModal.addEventListener('hidden.bs.modal', function () {
                    // Create and submit form dynamically
                    var form = document.createElement('form');
                    form.method = 'post';
                    form.action = '/user/logout';

                    document.body.appendChild(form);
                    form.submit();
                });
            }
        }
    });

    var result = [[${result}]];

    if(result) {
        // Account deletion confirmation modal
        if (result == "Deleted") {
            document.querySelector("#accountDeleteModalResult").innerHTML =
                `Thank you for using our service.<br>
                 Your account has been terminated as of <b>[[${delDate}]]</b>.`;
            var modal = new bootstrap.Modal(document.querySelector("#accountDeleteModal"));
            modal.show();
        }
        // Level up modal
        else if (result == "Level up") {
            document.querySelector("#levelUpModalResult").innerHTML =
                `Hooray!ü•≥<br>
                 Congratulations! You've reached <b>[[${level}]]</b> level.<br><br>
                Shall we go explore more books?`;
            var modal = new bootstrap.Modal(document.querySelector("#levelUpModal"));
            modal.show();
        }
        // Admin first time login - Password Change Modal
        else if (result == "Admin first time login") {
            var modal = new bootstrap.Modal(document.querySelector("#adminPasswordChangeModal"), {
                backdrop: 'static',
                keyboard: false // Prevent closing the modal
            });
            modal.show();
        }
    }

    // Password Validation
    const hasUpperCase = /[A-Z]/;
    const hasLowerCase = /[a-z]/;
    const hasDigit = /\d/;
    const hasSpecialChar = /[~!@#$%^&*=\+]/;

    document.getElementById('submitPasswordChange').addEventListener('click', function () {
        const newPw = document.getElementById('newPassword').value;
        const confirmPw = document.getElementById('confirmPassword').value;

        if (!newPw || !confirmPw) {
            alert("Please enter the password.");
        } else if (newPw.length < 8) {
            alert("Password must be at least 8 characters long.");
        } else if (newPw != confirmPw) {
            alert("Passwords are not same.");
        } else {
            let criteriaCount = 0;
            if (hasUpperCase.test(newPw)) criteriaCount++;
            if (hasLowerCase.test(newPw)) criteriaCount++;
            if (hasDigit.test(newPw)) criteriaCount++;
            if (hasSpecialChar.test(newPw)) criteriaCount++;

            if (criteriaCount < 3) {
                alert("Password must include at least three of the following: uppercase letters, lowercase letters, digits, and special characters.");
            } else {
                // Password meets all criteria, proceed with form submission
                const modalElement = document.querySelector("#adminPasswordChangeModal");
                const bootstrapModal = bootstrap.Modal.getInstance(modalElement);
                bootstrapModal.hide();  // Hide the modal

                const form = document.createElement('form');
                form.method = 'post';
                form.action = '/home';

                // Add hidden input field for new password
                const hiddenNewPw = document.createElement('input');
                hiddenNewPw.type = 'hidden';
                hiddenNewPw.name = 'newPw';
                hiddenNewPw.value = newPw;
                form.appendChild(hiddenNewPw);

                document.body.appendChild(form);
                form.submit();
            }
        }
    });
</script>
</html>
